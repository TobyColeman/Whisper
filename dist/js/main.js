/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

!function(){var e,t,n;!function(r){function i(e,t){return K.call(e,t)}function o(e,t){var n,r,i,o,s,a,c,l,u,d,y,p=t&&t.split("/"),f=v.map,h=f&&f["*"]||{};if(e&&"."===e.charAt(0))if(t){for(e=e.split("/"),s=e.length-1,v.nodeIdCompat&&E.test(e[s])&&(e[s]=e[s].replace(E,"")),e=p.slice(0,p.length-1).concat(e),u=0;u<e.length;u+=1)if(y=e[u],"."===y)e.splice(u,1),u-=1;else if(".."===y){if(1===u&&(".."===e[2]||".."===e[0]))break;u>0&&(e.splice(u-1,2),u-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((p||h)&&f){for(n=e.split("/"),u=n.length;u>0;u-=1){if(r=n.slice(0,u).join("/"),p)for(d=p.length;d>0;d-=1)if(i=f[p.slice(0,d).join("/")],i&&(i=i[r])){o=i,a=u;break}if(o)break;!c&&h&&h[r]&&(c=h[r],l=u)}!o&&c&&(o=c,a=l),o&&(n.splice(0,a,o),e=n.join("/"))}return e}function s(e,t){return function(){var n=k.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),p.apply(r,n.concat([e,t]))}}function a(e){return function(t){return o(t,e)}}function c(e){return function(t){g[e]=t}}function l(e){if(i(m,e)){var t=m[e];delete m[e],b[e]=!0,y.apply(r,t)}if(!i(g,e)&&!i(b,e))throw new Error("No "+e);return g[e]}function u(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function d(e){return function(){return v&&v.config&&v.config[e]||{}}}var y,p,f,h,g={},m={},v={},b={},K=Object.prototype.hasOwnProperty,k=[].slice,E=/\.js$/;f=function(e,t){var n,r=u(e),i=r[0];return e=r[1],i&&(i=o(i,t),n=l(i)),i?e=n&&n.normalize?n.normalize(e,a(t)):o(e,t):(e=o(e,t),r=u(e),i=r[0],e=r[1],i&&(n=l(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},h={require:function(e){return s(e)},exports:function(e){var t=g[e];return"undefined"!=typeof t?t:g[e]={}},module:function(e){return{id:e,uri:"",exports:g[e],config:d(e)}}},y=function(e,t,n,o){var a,u,d,y,p,v,K=[],k=typeof n;if(o=o||e,"undefined"===k||"function"===k){for(t=!t.length&&n.length?["require","exports","module"]:t,p=0;p<t.length;p+=1)if(y=f(t[p],o),u=y.f,"require"===u)K[p]=h.require(e);else if("exports"===u)K[p]=h.exports(e),v=!0;else if("module"===u)a=K[p]=h.module(e);else if(i(g,u)||i(m,u)||i(b,u))K[p]=l(u);else{if(!y.p)throw new Error(e+" missing "+u);y.p.load(y.n,s(o,!0),c(u),{}),K[p]=g[u]}d=n?n.apply(g[e],K):void 0,e&&(a&&a.exports!==r&&a.exports!==g[e]?g[e]=a.exports:d===r&&v||(g[e]=d))}else e&&(g[e]=n)},e=t=p=function(e,t,n,i,o){if("string"==typeof e)return h[e]?h[e](t):l(f(e,t).f);if(!e.splice){if(v=e,v.deps&&p(v.deps,v.callback),!t)return;t.splice?(e=t,t=n,n=null):e=r}return t=t||function(){},"function"==typeof n&&(n=i,i=o),i?y(r,e,t,n):setTimeout(function(){y(r,e,t,n)},4),p},p.config=function(e){return p(e)},e._defined=g,n=function(e,t,n){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),i(g,e)||i(m,e)||(m[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("Utils",[],function(){function e(){if(null!==t)throw new Error("Utils instance already exists")}var t=null;return e.prototype.addListenerToClass=function(e,t,n){var r=document.getElementsByClassName(e);if(0===r.length)return!1;for(var i=0;i<r.length;i++)r[i].addEventListener(t,n,!1);return!0},e.prototype.classExists=function(e){return document.getElementsByClassName(e)[0]?!0:!1},e.prototype.forEachChild=function(e,t){if(t(e),void 0!==e.children)for(var n=0;n<e.children.length;n++)this.forEachChild(e.children[n],t)},e.prototype.findObjWithAttribute=function(e,t,n){for(var r=0;r<e.length;r+=1)if(e[r][t]===n)return r},e.getInstance=function(){return null===t&&(t=new e),t},e.getInstance()}),n("EventManager",[],function(){function e(){if(null!==t)throw new Error("EventManager instance already exists")}var t=null,n={};return e.prototype.publish=function(e,t){return n[e]?void n[e].forEach(function(e){t?e(t):e()}):!1},e.prototype.subscribe=function(e,t){n[e]||(n[e]=[]),Array.isArray(t)||(t=[t]);for(var r=0;r<t.length;r++)n[e].push(t[r])},e.prototype.removeListener=function(e,t){return n[e]?void n[e].splice(t,1):!1},e.getInstance=function(){return null===t&&(t=new e),t},e.getInstance()}),n("Key",[],function(){function e(e){this.pubKey=openpgp.key.readArmored(e.pubKey).keys[0],this.privKey=void 0===e.privKey?null:openpgp.key.readArmored(e.privKey).keys[0],this.FBID,this.vanityID=e.vanityID}return e.prototype.getId=function(){return this.pubKey.users[0].userId.userid},e.prototype.setFBID=function(e){this.FBID=e},e.prototype.isUnlocked=function(){return this.privKey.primaryKey.isDecrypted},e.prototype.getName=function(){var e=this.getId(),t=e.split("<")[0];return t},e.prototype.getEmail=function(){var e=this.getId(),t=e.split("<")[1].replace(">","");return t},e.prototype.getPubKeyLength=function(){function e(e){var t=-1;return e.mpi.length>0&&(t=8*e.mpi[0].byteLength()),t}var t=this.pubKey.primaryKey;return null!==t&&(strength=e(t)),strength},e}),n("StoreController",["Key"],function(e){function t(){if(null!==n)throw new Error("StoreController instance already exists")}var n=null;return t.prototype.getKey=function(t,n){chrome.storage.local.get(t,function(r){delete r.settings,n(null===t?r:void 0===r[t]?!1:new e(r[t]))})},t.prototype.setKey=function(e,t,n,r){var i={};null!==n?i.whisper_key={vanityID:e,privKey:n,pubKey:t}:i[e]={vanityID:e,pubKey:t},this.sendUpdate(),chrome.storage.local.set(i,r)},t.prototype.delKey=function(e,t){var n=this;this.getKey(e,function(r){r?(chrome.storage.local.remove(e,t(!0)),n.sendUpdate(),"whisper_key"==e&&chrome.storage.local.remove(r.vanityID)):t(!1)})},t.prototype.hasPrivKey=function(e){this.getKey("whisper_key",e)},t.prototype.hasFriends=function(t){this.getKey(null,function(n){var r=!1;if(n.whisper_key){var i=n.whisper_key.vanityID;delete n[i],delete n.whisper_key}if(Object.keys(n).length>0){r=[];for(key in n)r.push(new e({vanityID:n[key].vanityID,pubKey:n[key].pubKey}))}t(r)})},t.prototype.getSettings=function(e,t){chrome.storage.local.get({settings:{}},function(n){var r=n.settings;t(void 0===r[e]?!1:r[e])})},t.prototype.setSettings=function(e,t){chrome.storage.local.get({settings:{}},function(n){var r=n.settings;r[e]=r[e]===!1||void 0===r[e]?!0:!1,chrome.storage.local.set({settings:r},t)})},t.prototype.sendUpdate=function(){chrome.runtime.sendMessage({type:"key_update"})},t.getInstance=function(){return null===n&&(n=new t),n},t.getInstance()}),n("KeyController",["StoreController","Key","EventManager"],function(e,t,n){function r(){if(self=this,null!==i)throw new Error("KeyController instance already exists")}var i=null,o={invalidKey:chrome.i18n.getMessage("invalidKeyError"),noPrivKey:chrome.i18n.getMessage("noPrivKeyError"),noPubKey:chrome.i18n.getMessage("noPubKeyError"),wrongPassword:chrome.i18n.getMessage("wrongPasswordError"),keyExits:chrome.i18n.getMessage("keyExistsError")};return r.prototype.init=function(){n.subscribe("newKey",this.generateKey),n.subscribe("privKeyInsert",this.insertPrivKey),n.subscribe("pubKeyInsert",this.insertPubKey),e.hasPrivKey(function(e){e?n.publish("newPrivKey",{keys:e}):n.publish("noPrivKey",{keys:!1})}),e.hasFriends(function(e){e?n.publish("newPubKey",{keys:e}):n.publish("noPubKeys",{keys:!1})})},r.prototype.generateKey=function(r){var i={numBits:r.numBits,userId:r.name+" <"+r.email+">",passphrase:r.password};openpgp.generateKeyPair(i).then(function(i){var o=i.privateKeyArmored,s=i.publicKeyArmored;e.setKey(r.vanityID,s,o,function(){n.publish("newPrivKey",{keys:new t({vanityID:r.vanityID,pubKey:s,privKey:o})}),self.insertPubKey({vanityID:r.vanityID,pubKey:s,noUpdate:!0})})})},r.prototype.insertPrivKey=function(r){var i=self.checkKeyIntegrity(r.privKey);return i.err?void n.publish("error",{error:o.invalidKeyError}):i.key.isPrivate()?self.validateKeyPassword(i.key,r.password)?void e.getKey(null,function(s){if(void 0!==s[r.vanityID])return void n.publish("error",{error:o.keyExits+r.vanityID});var a=i.key.toPublic().armor();e.setKey(r.vanityID,a,r.privKey,function(){n.publish("newPrivKey",{keys:new t({vanityID:r.vanityID,pubKey:a,privKey:r.privKey})}),self.insertPubKey({vanityID:r.vanityID,pubKey:a,noUpdate:!0})})}):void n.publish("error",{error:o.wrongPassword}):void n.publish("error",{error:o.noPrivKey})},r.prototype.insertPubKey=function(r){var i=self.checkKeyIntegrity(r.pubKey);return i.err?void n.publish("error",{error:o.invalidKey}):i.key.isPublic()?void e.getKey(null,function(i){return void 0!==i[r.vanityID]?void n.publish("error",{error:o.keyExits+r.vanityID}):void e.setKey(r.vanityID,r.pubKey,null,function(){r.noUpdate||n.publish("newPubKey",{keys:new t({vanityID:r.vanityID,pubKey:r.pubKey})})})}):void n.publish("error",{error:o.noPubKey})},r.prototype.checkKeyIntegrity=function(e){var t=openpgp.key.readArmored(e);return t.err?{err:t.err[0].message}:{key:t.keys[0]}},r.prototype.validateKeyPassword=function(e,t){return e.decrypt(t)?!0:!1},r.getInstance=function(){return null===i&&(i=new r),i},r.getInstance()}),n("MessageController",["EventManager","Utils"],function(e){function t(){if(self=this,null!==n)throw new Error("MessageController instance already exists")}var n=null;return t.prototype.init=function(t){chrome.runtime.sendMessage({type:"is_enabled"},function(n){n.success&&(e.subscribe("set_thread",self.getThreadInfo),e.subscribe("decrypt_key",self.decryptKey),e.subscribe("set_encryption",function(e){chrome.runtime.sendMessage({type:"set_encryption",encrypted:e.encrypted})}),e.subscribe("disable_decryption",function(){chrome.runtime.sendMessage({type:"disable_decryption"})})),t(n.success)})},t.prototype.getThreadInfo=function(t){function n(t){chrome.runtime.sendMessage({type:"set_thread_info",data:t},function(t){t.hasAllKeys?e.publish("renderThreadSettings",{isEncrypted:t.encrypted,keys:t.keys,hasAllKeys:!0}):e.publish("renderThreadSettings",{isEncrypted:t.encrypted,keys:t.keys,hasAllKeys:!1})})}chrome.runtime.sendMessage({type:"get_post_data",site:t.site},function(e){postData=e.payload,self.makeRequest("/ajax/mercury/threadlist_info.php",{type:"POST",params:"inbox[offset]="+t.threadIndex+"&inbox[limit]=1&__user="+postData.uid+"&__a=1b&__req=1&fb_dtsg="+postData.fb_dtsg,retries:3},n)})},t.prototype.decryptKey=function(t){chrome.runtime.sendMessage({type:"decrypt_key",password:t.password},function(t){e.publish(t.success?"correctPassword":"wrongPassword")})},t.prototype.makeRequest=function(e,t,n){function r(){i.open(t.type,e,!0),"POST"===t.type?i.send(t.params):i.send()}var i=new XMLHttpRequest,o=t.retries;i.onreadystatechange=function(){4==i.readyState&&200==i.status?n(i.responseText.replace("for (;;);","")):4==i.readyState&&200!=i.status&&(o--,o>0&&setTimeout(function(){r()},1e3))},r()},t.getInstance=function(){return null===n&&(n=new t),n},t.getInstance()}),n("Thread",[],function(){function e(e){this.id=e,this.isEncrypted=!1,this.hasAllKeys=!0,this.numPeople=0,this.keys={}}return e.prototype.setEncrypted=function(e){this.isEncrypted=e},e.prototype.setNumPeople=function(){this.numPeople+=1},e.prototype.addKey=function(e){this.keys[e.FBID]=e,this.setNumPeople()},e.prototype.removeKey=function(e){var t=this.keys.indexOf(e);t>-1&&this.keys.splice(t,1)},e}),n("MessageWriter",["Thread","StoreController"],function(e,t){function n(){if(r=this,this.thread=null,null!==i)throw new Error("MessageWriter instance already exists")}var r,i=null;return n.prototype.encryptMessage=function(e,t){var n=/\[body\]=(.*?)&/,i=e.match(n);if(null===i)return void t({message:e});if(i=decodeURIComponent(i[1]),r.thread.isEncrypted){var o={};!function(){function s(){if(a<r.thread.numPeople){var c=parseInt(Object.keys(r.thread.keys)[a]);openpgp.encryptMessage(r.thread.keys[c].pubKey,i).then(function(e){o[r.thread.keys[c].FBID]=e,a++,s()})}else o="[body]="+encodeURIComponent(JSON.stringify(o))+"&",e=e.replace(n,o),t({message:e})}var a=0;s()}()}else t({message:e})},n.prototype.setThread=function(n,i){var o,s,a;o=JSON.parse(n),a=o.payload.participants,s=o.payload.ordered_threadlists[0].thread_fbids[0],void 0===s&&(s=o.payload.ordered_threadlists[0].other_user_fbids[0]),this.thread=new e(s),t.getSettings(this.thread.id,function(e){!function(){function n(){o<a.length?t.getKey(a[o].vanity,function(e){{var t=a[o].fbid;a[o].vanity}e?(e.setFBID(t),r.thread.addKey(e)):r.thread.hasAllKeys=!1,o++,n()}):(i({hasAllKeys:r.thread.hasAllKeys,encrypted:e,keys:r.thread.keys}),t.getSettings(r.thread.id,function(e){r.thread.setEncrypted(e)}))}var o=0;n()}()})},n.prototype.updateEncryptionSettings=function(e){r.thread.setEncrypted(e),t.setSettings(r.thread.id)},n.getInstance=function(){return null===i&&(i=new n),i},n.getInstance()}),n("messengerView",["Utils","EventManager"],function(e,t){function n(){r()&&(l(),u(),o(),i(),s())}function r(){for(var t in d)if(!e.classExists(d[t])&&-1===y.indexOf(t))return console.log("STYLE: ",t," was not found."),!1;return!0}function i(){t.subscribe("renderThreadSettings",c),t.subscribe("getPassword",function(){document.getElementById("pwDialog").showModal()}),t.subscribe("wrongPassword",function(){document.getElementById("pwDialog").children[0].style.display="block"}),t.subscribe("correctPassword",function(){document.getElementById("pwDialog").children[0].style.display="none",document.getElementById("pwDialog").close()}),t.subscribe("get_thread_index",s)}function o(){var e=document.getElementsByClassName(d.heading)[0],n={attributes:!0,childList:!0,characterData:!0,subtree:!0},r=new MutationObserver(function(){s()});r.observe(e,n);var i=document.getElementsByClassName(d.threadInfoPaneWrapper)[0],n={attributes:!0,subtree:!1},o=new MutationObserver(function(){l()});o.observe(i,n),checkBox=document.getElementById("encryption-toggle").getElementsByTagName("INPUT")[0],inputBox=document.getElementsByClassName("_54-z")[0],checkBox.addEventListener("click",function(){t.publish("set_encryption",{encrypted:checkBox.checked})}),document.getElementById("closeDialog").addEventListener("click",function(e){e.preventDefault(),checkBox.checked=!1,document.getElementById("pwDialog").children[0].style.display="none",document.getElementById("keyPw").value="",t.publish("disable_decryption",{enabled:!1}),document.getElementById("pwDialog").close()}),document.getElementById("keyPw").onkeydown=function(e){13==e.keyCode?(e.preventDefault(),a(e)):27==e.keyCode&&t.publish("disable_decryption",{enabled:!1})},document.getElementById("submitDialog").addEventListener("click",a),document.getElementById("pwDialog").showModal()}function s(){var e=document.getElementsByClassName(d.activeThread)[0],n=Array.prototype.slice.call(e.parentElement.children);e=n.indexOf(e),inputBox.setAttribute("contenteditable",!1),checkBox.disabled=!0,checkBox.checked=!1,t.publish("set_thread",{site:"messenger",threadIndex:e})}function a(e){e.preventDefault();var n=document.getElementById("keyPw").value;t.publish("decrypt_key",{password:n})}function c(e){function t(e,t){var n=document.createElement("SPAN");n.className=e?"ion-locked ion-padded ion-blue":"ion-unlocked ion-padded",t.appendChild(n)}var n=checkBox.parentNode.parentNode.children[1];e.hasAllKeys?(checkBox.disabled=!1,n.style.textDecoration="none",n.style.color="#141823",checkBox.checked=e.isEncrypted):(checkBox.disabled=!0,n.style.textDecoration="line-through",n.style.color="#F0F0F0"),inputBox.setAttribute("contenteditable",!0);var r=document.getElementsByClassName("_3eur")[0];if(r){if(r=r.children[0],r.children.length>0)for(var i=0;i<r.children.length;i++)"SPAN"==r.children[i].tagName&&r.removeChild(r.children[i]);var o=document.getElementsByClassName(d.profileLink)[2].children[0].href.split("/")[3];for(key in e.keys)if(e.keys[key].vanityID==o)return void t(key,r);return void t(!1,r)}for(var s=document.getElementsByClassName(d.threadPeopleList)[0].getElementsByTagName("UL")[0].children,i=0;i<s.length;i++){var a=(document.createElement("SPAN"),s[i].getAttribute("data-reactid").split("$fbid=2")[1]),r=s[i].getElementsByClassName("_364g")[0],c=void 0!==e.keys[a]?!0:!1;r.children.length<1&&t(c,r)}}function l(){var t=document.getElementsByClassName(d.threadInfoPane)[0];if(void 0!==t&&null===document.getElementById("encryption-toggle")){var n=t.childNodes[1].cloneNode(!0);n.id="encryption-toggle",n.getElementsByClassName(d.colSpan)[0].innerText=chrome.i18n.getMessage("Encryption"),e.forEachChild(n,function(e){e.removeAttribute("data-reactid")}),t.childNodes[1].insertAdjacentElement("afterEnd",n)}}function u(){var e=document.createElement("DIALOG"),t=document.createElement("P"),n=document.createElement("FORM"),r=document.createElement("DIV"),i=document.createElement("INPUT"),o=document.createElement("BUTTON"),s=document.createElement("BUTTON");e.id="pwDialog",t.innerText=chrome.i18n.getMessage("wrongPasswordError"),i.type="text",i.id="keyPw",i.placeholder="Private Key Password",o.id="submitDialog",o.innerText=chrome.i18n.getMessage("OKPrompt"),s.id="closeDialog",s.innerText=chrome.i18n.getMessage("ClosePrompt"),n.appendChild(i),n.appendChild(r),r.appendChild(s),r.appendChild(o),e.appendChild(t),e.appendChild(n),document.body.appendChild(e)}var d={heading:"_3oh-",activeThread:"_1ht2",threadInfoPane:"_3tkv",threadPersonName:"_3eur",threadPeopleList:"_4wc-",threadInfoPaneWrapper:"_4_j5",colSpan:"_3x6u",infoBtn:"_fl3 _30yy",profileLink:"_3tl1"},y=["rightCol","colSpan","threadPeopleList","threadPersonName"];return{init:n}}),n("main",["messengerView","MessageController"],function(e,t){t.init(function(t){t&&window.addEventListener("load",function(){e.init()})})}),t(["main"],null,null,!0)}();