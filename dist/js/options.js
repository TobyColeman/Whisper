/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

!function(){var e,n,t;!function(r){function i(e,n){return K.call(e,n)}function o(e,n){var t,r,i,o,s,l,u,a,y,d,c,p=n&&n.split("/"),m=h.map,f=m&&m["*"]||{};if(e&&"."===e.charAt(0))if(n){for(e=e.split("/"),s=e.length-1,h.nodeIdCompat&&k.test(e[s])&&(e[s]=e[s].replace(k,"")),e=p.slice(0,p.length-1).concat(e),y=0;y<e.length;y+=1)if(c=e[y],"."===c)e.splice(y,1),y-=1;else if(".."===c){if(1===y&&(".."===e[2]||".."===e[0]))break;y>0&&(e.splice(y-1,2),y-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((p||f)&&m){for(t=e.split("/"),y=t.length;y>0;y-=1){if(r=t.slice(0,y).join("/"),p)for(d=p.length;d>0;d-=1)if(i=m[p.slice(0,d).join("/")],i&&(i=i[r])){o=i,l=y;break}if(o)break;!u&&f&&f[r]&&(u=f[r],a=y)}!o&&u&&(o=u,l=a),o&&(t.splice(0,l,o),e=t.join("/"))}return e}function s(e,n){return function(){var t=I.call(arguments,0);return"string"!=typeof t[0]&&1===t.length&&t.push(null),p.apply(r,t.concat([e,n]))}}function l(e){return function(n){return o(n,e)}}function u(e){return function(n){v[e]=n}}function a(e){if(i(g,e)){var n=g[e];delete g[e],b[e]=!0,c.apply(r,n)}if(!i(v,e)&&!i(b,e))throw new Error("No "+e);return v[e]}function y(e){var n,t=e?e.indexOf("!"):-1;return t>-1&&(n=e.substring(0,t),e=e.substring(t+1,e.length)),[n,e]}function d(e){return function(){return h&&h.config&&h.config[e]||{}}}var c,p,m,f,v={},g={},h={},b={},K=Object.prototype.hasOwnProperty,I=[].slice,k=/\.js$/;m=function(e,n){var t,r=y(e),i=r[0];return e=r[1],i&&(i=o(i,n),t=a(i)),i?e=t&&t.normalize?t.normalize(e,l(n)):o(e,n):(e=o(e,n),r=y(e),i=r[0],e=r[1],i&&(t=a(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:t}},f={require:function(e){return s(e)},exports:function(e){var n=v[e];return"undefined"!=typeof n?n:v[e]={}},module:function(e){return{id:e,uri:"",exports:v[e],config:d(e)}}},c=function(e,n,t,o){var l,y,d,c,p,h,K=[],I=typeof t;if(o=o||e,"undefined"===I||"function"===I){for(n=!n.length&&t.length?["require","exports","module"]:n,p=0;p<n.length;p+=1)if(c=m(n[p],o),y=c.f,"require"===y)K[p]=f.require(e);else if("exports"===y)K[p]=f.exports(e),h=!0;else if("module"===y)l=K[p]=f.module(e);else if(i(v,y)||i(g,y)||i(b,y))K[p]=a(y);else{if(!c.p)throw new Error(e+" missing "+y);c.p.load(c.n,s(o,!0),u(y),{}),K[p]=v[y]}d=t?t.apply(v[e],K):void 0,e&&(l&&l.exports!==r&&l.exports!==v[e]?v[e]=l.exports:d===r&&h||(v[e]=d))}else e&&(v[e]=t)},e=n=p=function(e,n,t,i,o){if("string"==typeof e)return f[e]?f[e](n):a(m(e,n).f);if(!e.splice){if(h=e,h.deps&&p(h.deps,h.callback),!n)return;n.splice?(e=n,n=t,t=null):e=r}return n=n||function(){},"function"==typeof t&&(t=i,i=o),i?c(r,e,n,t):setTimeout(function(){c(r,e,n,t)},4),p},p.config=function(e){return p(e)},e._defined=v,t=function(e,n,t){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");n.splice||(t=n,n=[]),i(v,e)||i(g,e)||(g[e]=[e,n,t])},t.amd={jQuery:!0}}(),t("Utils",[],function(){function e(){if(null!==n)throw new Error("Utils instance already exists")}var n=null;return e.prototype.addListenerToClass=function(e,n,t){var r=document.getElementsByClassName(e);if(0===r.length)return!1;for(var i=0;i<r.length;i++)r[i].addEventListener(n,t,!1);return!0},e.prototype.classExists=function(e){return document.getElementsByClassName(e)[0]?!0:!1},e.prototype.forEachChild=function(e,n){if(n(e),void 0!==e.children)for(var t=0;t<e.children.length;t++)this.forEachChild(e.children[t],n)},e.prototype.findObjWithAttribute=function(e,n,t){for(var r=0;r<e.length;r+=1)if(e[r][n]===t)return r},e.getInstance=function(){return null===n&&(n=new e),n},e.getInstance()}),t("EventManager",[],function(){function e(){if(null!==n)throw new Error("EventManager instance already exists")}var n=null,t={};return e.prototype.publish=function(e,n){return t[e]?void t[e].forEach(function(e){n?e(n):e()}):!1},e.prototype.subscribe=function(e,n){t[e]||(t[e]=[]),Array.isArray(n)||(n=[n]);for(var r=0;r<n.length;r++)t[e].push(n[r])},e.prototype.removeListener=function(e,n){return t[e]?void t[e].splice(n,1):!1},e.getInstance=function(){return null===n&&(n=new e),n},e.getInstance()}),t("Key",[],function(){function e(e){this.pubKey=openpgp.key.readArmored(e.pubKey).keys[0],this.privKey=void 0===e.privKey?null:openpgp.key.readArmored(e.privKey).keys[0],this.FBID,this.vanityID=e.vanityID}return e.prototype.getId=function(){return this.pubKey.users[0].userId.userid},e.prototype.setFBID=function(e){this.FBID=e},e.prototype.isUnlocked=function(){return this.privKey.primaryKey.isDecrypted},e.prototype.getName=function(){var e=this.getId(),n=e.split("<")[0];return n},e.prototype.getEmail=function(){var e=this.getId(),n=e.split("<")[1].replace(">","");return n},e.prototype.getPubKeyLength=function(){function e(e){var n=-1;return e.mpi.length>0&&(n=8*e.mpi[0].byteLength()),n}var n=this.pubKey.primaryKey;return null!==n&&(strength=e(n)),strength},e}),t("StoreController",["Key"],function(e){function n(){if(null!==t)throw new Error("StoreController instance already exists")}var t=null;return n.prototype.getKey=function(n,t){chrome.storage.local.get(n,function(r){delete r.settings,t(null===n?r:void 0===r[n]?!1:new e(r[n]))})},n.prototype.setKey=function(e,n,t,r){var i={};null!==t?i.whisper_key={vanityID:e,privKey:t,pubKey:n}:i[e]={vanityID:e,pubKey:n},this.sendUpdate(),chrome.storage.local.set(i,r)},n.prototype.delKey=function(e,n){var t=this;this.getKey(e,function(r){r?(chrome.storage.local.remove(e,n(!0)),t.sendUpdate(),"whisper_key"==e&&chrome.storage.local.remove(r.vanityID)):n(!1)})},n.prototype.hasPrivKey=function(e){this.getKey("whisper_key",e)},n.prototype.hasFriends=function(n){this.getKey(null,function(t){var r=!1;if(t.whisper_key){var i=t.whisper_key.vanityID;delete t[i],delete t.whisper_key}if(Object.keys(t).length>0){r=[];for(key in t)r.push(new e({vanityID:t[key].vanityID,pubKey:t[key].pubKey}))}n(r)})},n.prototype.getSettings=function(e,n){chrome.storage.local.get({settings:{}},function(t){var r=t.settings;n(void 0===r[e]?!1:r[e])})},n.prototype.setSettings=function(e,n){chrome.storage.local.get({settings:{}},function(t){var r=t.settings;r[e]=r[e]===!1||void 0===r[e]?!0:!1,chrome.storage.local.set({settings:r},n)})},n.prototype.sendUpdate=function(){chrome.runtime.sendMessage({type:"key_update"})},n.getInstance=function(){return null===t&&(t=new n),t},n.getInstance()}),t("KeyController",["StoreController","Key","EventManager"],function(e,n,t){function r(){if(self=this,null!==i)throw new Error("KeyController instance already exists")}var i=null,o={invalidKey:chrome.i18n.getMessage("invalidKeyError"),noPrivKey:chrome.i18n.getMessage("noPrivKeyError"),noPubKey:chrome.i18n.getMessage("noPubKeyError"),wrongPassword:chrome.i18n.getMessage("wrongPasswordError"),keyExits:chrome.i18n.getMessage("keyExistsError")};return r.prototype.init=function(){t.subscribe("newKey",this.generateKey),t.subscribe("privKeyInsert",this.insertPrivKey),t.subscribe("pubKeyInsert",this.insertPubKey),e.hasPrivKey(function(e){e?t.publish("newPrivKey",{keys:e}):t.publish("noPrivKey",{keys:!1})}),e.hasFriends(function(e){e?t.publish("newPubKey",{keys:e}):t.publish("noPubKeys",{keys:!1})})},r.prototype.generateKey=function(r){var i={numBits:r.numBits,userId:r.name+" <"+r.email+">",passphrase:r.password};openpgp.generateKeyPair(i).then(function(i){var o=i.privateKeyArmored,s=i.publicKeyArmored;e.setKey(r.vanityID,s,o,function(){t.publish("newPrivKey",{keys:new n({vanityID:r.vanityID,pubKey:s,privKey:o})}),self.insertPubKey({vanityID:r.vanityID,pubKey:s,noUpdate:!0})})})},r.prototype.insertPrivKey=function(r){var i=self.checkKeyIntegrity(r.privKey);return i.err?void t.publish("error",{error:o.invalidKeyError}):i.key.isPrivate()?self.validateKeyPassword(i.key,r.password)?void e.getKey(null,function(s){if(void 0!==s[r.vanityID])return void t.publish("error",{error:o.keyExits+r.vanityID});var l=i.key.toPublic().armor();e.setKey(r.vanityID,l,r.privKey,function(){t.publish("newPrivKey",{keys:new n({vanityID:r.vanityID,pubKey:l,privKey:r.privKey})}),self.insertPubKey({vanityID:r.vanityID,pubKey:l,noUpdate:!0})})}):void t.publish("error",{error:o.wrongPassword}):void t.publish("error",{error:o.noPrivKey})},r.prototype.insertPubKey=function(r){var i=self.checkKeyIntegrity(r.pubKey);return i.err?void t.publish("error",{error:o.invalidKey}):i.key.isPublic()?void e.getKey(null,function(i){return void 0!==i[r.vanityID]?void t.publish("error",{error:o.keyExits+r.vanityID}):void e.setKey(r.vanityID,r.pubKey,null,function(){r.noUpdate||t.publish("newPubKey",{keys:new n({vanityID:r.vanityID,pubKey:r.pubKey})})})}):void t.publish("error",{error:o.noPubKey})},r.prototype.checkKeyIntegrity=function(e){var n=openpgp.key.readArmored(e);return n.err?{err:n.err[0].message}:{key:n.keys[0]}},r.prototype.validateKeyPassword=function(e,n){return e.decrypt(n)?!0:!1},r.getInstance=function(){return null===i&&(i=new r),i},r.getInstance()}),t("optionsView",["Utils","EventManager","StoreController"],function(e,n,t){function r(){document.forms.keyGenForm.addEventListener("submit",u),document.forms.keyInsForm.addEventListener("submit",a),document.forms.friendInsForm.addEventListener("submit",y),document.forms.delForm.addEventListener("submit",m),document.getElementById("keyOpts").addEventListener("change",c),document.getElementById("friendFormToggle").addEventListener("click",d),e.addListenerToClass("close","click",function(){this.parentNode.close()}),n.subscribe("newPubKey",s),n.subscribe("noPubKeys",s),n.subscribe("newPrivKey",o),n.subscribe("noPrivKey",o),n.subscribe("error",i)}function i(e){var n=document.getElementById("errorBlock");n.children.namedItem("blockText").innerHTML="Error: "+e.error,document.getElementById("keyGenProgress").style.display="none",n.style.display="block",setTimeout(function(){n.style.display="none"},2e3)}function o(e){var n=document.getElementById("keyFormWrapper"),t=document.getElementById("key_table");return e.keys?(l(e.keys,t),t.style.display="block",document.getElementById("keyGenProgress").style.display="none",document.forms.keyGenForm.reset(),document.forms.keyInsForm.reset(),void(n.style.display="none")):(n.style.display="block",void(t.style.display="none"))}function s(e){var n=document.getElementById("friend_table"),t=document.getElementById("no_friends");return e.keys?(l(e.keys,n),n.style.display="block",document.forms.friendInsForm.reset(),void(t.style.display="none")):(t.style.display="block",void(n.style.display="none"))}function l(e,n){e=Array.isArray(e)?e:[e],e.forEach(function(e,t){var r=n.insertRow(t+1);r.insertCell(0).innerHTML=e.vanityID,r.insertCell(1).innerHTML=e.getName(),r.insertCell(2).innerHTML=e.getEmail();var i=document.createElement("A");i.innerHTML="show key",i.href="#",i.addEventListener("click",f);var o=document.createElement("SPAN");o.className="ion-trash-b ion-medium ion-clickable",o.addEventListener("click",p),null!=e.privKey?(i.setAttribute("data-uid","whisper_key"),o.setAttribute("data-uid","whisper_key")):(i.setAttribute("data-uid",e.vanityID),o.setAttribute("data-uid",e.vanityID)),r.insertCell(3).appendChild(i),r.insertCell(4).innerHTML=e.getPubKeyLength(),r.insertCell(5).appendChild(o)})}function u(e){e.preventDefault();var t=document.forms.keyGenForm,r=t.vanityID.value.trim().toLowerCase(),i=t.name.value.trim(),o=t.email.value.trim(),s=t.password.value,l=t.numBits[t.numBits.selectedIndex].value;document.getElementById("keyGenProgress").style.display="block",n.publish("newKey",{vanityID:r,name:i,email:o,password:s,numBits:l})}function a(e){e.preventDefault();var t=document.forms.keyInsForm,r=t.vanityID.value.trim().toLowerCase(),i=t.password.value,o=t.privKey.value.trim();document.getElementById("keyGenProgress").style.display="block",n.publish("privKeyInsert",{vanityID:r,password:i,privKey:o})}function y(e){e.preventDefault();var t=document.forms.friendInsForm,r=t.vanityID.value.trim().toLowerCase(),i=t.pubKey.value.trim();n.publish("pubKeyInsert",{vanityID:r,pubKey:i})}function d(){document.forms.friendInsForm.style.display="none"==document.forms.friendInsForm.style.display?"block":"none"}function c(e){1==e.target.value?(document.forms.keyGenForm.style.display="block",document.forms.keyInsForm.style.display="none"):(document.forms.keyGenForm.style.display="none",document.forms.keyInsForm.style.display="block")}function p(e){function n(){var e=document.getElementById("delModal");e.children.namedItem("delMsg").children.namedItem("delName").innerHTML=o,document.forms.delForm.keyId.value=s,document.forms.delForm.rowIndex.value=r,document.forms.delForm.tableId.value=i,e.showModal()}var t=e.target.parentNode.parentElement,r=t.rowIndex,i=t.parentElement.parentElement.id,o=e.target.parentElement.parentElement.childNodes[1].innerHTML,s=e.target.getAttribute("data-uid");n()}function m(e){e.preventDefault();var r=document.forms.delForm.keyId.value,o=document.forms.delForm.tableId.value,s=document.forms.delForm.rowIndex.value;t.delKey(r,function(e){return e?("whisper_key"===r?n.publish("noPrivKey",{keys:!1}):2===document.getElementById("friend_table").rows.length&&n.publish("noPubKeys",{keys:!1}),document.getElementById(o).rows[s].remove(),void document.forms.delForm.parentNode.close()):void i({error:"Could not find key"})})}function f(e){function n(e,n){var r=e.target.getAttribute("data-uid");t.getKey(r,function(e){return e?void n(e):void i({error:"Could not find key"})})}function r(e){var n=document.getElementById("keyModal");n.children.namedItem("modalHeading").innerHTML="Key For: "+e.getName()+" - "+e.vanityID,null===e.privKey?(n.children.namedItem("privKeyText").style.display="none",n.children.namedItem("privateHeading").style.display="none"):(n.children.namedItem("privKeyText").style.display="block",n.children.namedItem("privateHeading").style.display="block",n.children.namedItem("privKeyText").innerHTML=e.privKey.armor()),n.children.namedItem("pubKeyText").innerHTML=e.pubKey.armor(),n.showModal()}n(e,r)}return e.forEachChild(document.documentElement,function(e){var n=e.dataset.i18n;n&&("INPUT"==e.tagName||"TEXTAREA"==e.tagName?e.placeholder=chrome.i18n.getMessage(n):e.childNodes.length?e.childNodes[0].innerHTML=chrome.i18n.getMessage(n):e.innerHTML=chrome.i18n.getMessage(n))}),{renderUserKey:o,renderFriendTable:s,renderError:i,bindEvents:r}}),t("options",["KeyController","optionsView"],function(e,n){n.bindEvents(),e.init()}),n(["options"],null,null,!0)}();